<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="PHP,文件上传," />





  <link rel="alternate" href="/atom.xml" title="语法糖的博客" type="application/atom+xml" />






<meta name="description" content="今天遇到一个问题，关于大文件的上传。其实不管是大文件的上传，还是普通的文件上传，一直都是迷迷糊糊的，今天对其进行整理下。">
<meta name="keywords" content="PHP,文件上传">
<meta property="og:type" content="article">
<meta property="og:title" content="文件上传">
<meta property="og:url" content="http://yoursite.com/2018/01/26/文件上传/index.html">
<meta property="og:site_name" content="语法糖的博客">
<meta property="og:description" content="今天遇到一个问题，关于大文件的上传。其实不管是大文件的上传，还是普通的文件上传，一直都是迷迷糊糊的，今天对其进行整理下。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-02-23T12:50:17.137Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="文件上传">
<meta name="twitter:description" content="今天遇到一个问题，关于大文件的上传。其实不管是大文件的上传，还是普通的文件上传，一直都是迷迷糊糊的，今天对其进行整理下。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/26/文件上传/"/>





  <title>文件上传 | 语法糖的博客</title>
  








</head>


    <script type="text/javascript" src="/live2d/script.js"></script>
    <canvas id="live2dcanvas" width="150" height="300" class="live2d"></canvas>
    <style>
      #live2dcanvas {
        position: fixed;
        right: 0px;
        z-index: 999;
        pointer-events: none;
        bottom: -40px;
      }
    </style>
    <script>loadlive2d("live2dcanvas" ,"/live2d/assets/wanko/wanko.model.json",0.5)</script>
  

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">语法糖的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">爱动漫，热爱LOL</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    




  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/26/文件上传/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chenye2017">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/my.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="语法糖的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">文件上传</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-26T18:26:03+08:00">
                2018-01-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>今天遇到一个问题，关于大文件的上传。其实不管是大文件的上传，还是普通的文件上传，一直都是迷迷糊糊的，今天对其进行整理下。<br><a id="more"></a><br>首先，最基本的，文件大小单位</p>
<blockquote>
<p>1KB等于1024B，B是英文Byte(比特，字节)的缩写,KB即kilobyte,字面意思就是千比特。<br>byte是文件大小的一个计量单位，大家都知道在计算机里面，文件都是以二进制方式存储的，这样一个最小的存储单元（譬如10、11、01、00）叫做一个bit(位，位元)，八个位元等于一个比特。<br>转换关系：<br>8bit=1b<br>1024byte=1kb<br>1024kb=1mb<br>1024mb=1gb<br>1024gb=1tb<br>以上单位k指千、m指百万、g指10亿，t指万亿，大小写均可。<br>因为1024≈1000，所以1024b,也称为1k，以下类似。</p>
</blockquote>
<p>简单点说就是 1G =1024M  1M = 1024K  1K=1024B  B之后就是位了，8位是1B，一般都是B为计量单位。</p>
<p><a href="http://www.runoob.com/php/php-file-upload.html" target="_blank" rel="external">菜鸟教程这里面有对最基本的php文件上传的demo</a></p>
<p>html :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">&lt;title&gt;&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line"></div><div class="line">&lt;form action=&quot;upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</div><div class="line">    &lt;label for=&quot;file&quot;&gt;文件名：&lt;/label&gt;</div><div class="line">    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;&lt;br&gt;</div><div class="line">    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;提交&quot;&gt;</div><div class="line">&lt;/form&gt;</div><div class="line"></div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>这个是以最基本的表单提交方式，当点击提交的时候文件就直接飞到upload_file.php那边了，注意接受的变量以表单控件的name字段的内容为变量名（$_POST[]）数组里面（想了下，其实框架的路由都是从这些大数组里面获取变量的信息）。<br>这个 <strong>enctype</strong> 很重要</p>
<blockquote>
<p><form> 标签的 enctype 属性规定了在提交表单时要使用哪种内容类型。在表单需要二进制数据时，比如文件内容，请使用 “multipart/form-data”。</form></p>
<p><input> 标签的 type=”file” 属性规定了应该把输入作为文件来处理。举例来说，当在浏览器中预览时，会看到输入框旁边有一个浏览按钮。</p>
</blockquote>
<p>不仅是这块，当用curl模拟文件上传的时候，也有相关的参数设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl_setopt($ch, CURLOPT_POSTFIELDS, $params);</div></pre></td></tr></table></figure></p>
<p>这个param如果是普通的post数据提交，要拼接成&amp;这种string方式，如果是文件上传，直接是传输组参数就可以了。</p>
<p>php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line">// 允许上传的图片后缀</div><div class="line">$allowedExts = array(&quot;gif&quot;, &quot;jpeg&quot;, &quot;jpg&quot;, &quot;png&quot;);</div><div class="line">$temp = explode(&quot;.&quot;, $_FILES[&quot;file&quot;][&quot;name&quot;]);</div><div class="line">echo $_FILES[&quot;file&quot;][&quot;size&quot;];</div><div class="line">$extension = end($temp);     // 获取文件后缀名</div><div class="line">if ((($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/gif&quot;)</div><div class="line">|| ($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/jpeg&quot;)</div><div class="line">|| ($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/jpg&quot;)</div><div class="line">|| ($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/pjpeg&quot;)</div><div class="line">|| ($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/x-png&quot;)</div><div class="line">|| ($_FILES[&quot;file&quot;][&quot;type&quot;] == &quot;image/png&quot;))</div><div class="line">&amp;&amp; ($_FILES[&quot;file&quot;][&quot;size&quot;] &lt; 204800)   // 小于 200 kb</div><div class="line">&amp;&amp; in_array($extension, $allowedExts))</div><div class="line">&#123;</div><div class="line">    if ($_FILES[&quot;file&quot;][&quot;error&quot;] &gt; 0)</div><div class="line">    &#123;</div><div class="line">        echo &quot;错误：: &quot; . $_FILES[&quot;file&quot;][&quot;error&quot;] . &quot;&lt;br&gt;&quot;;</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        echo &quot;上传文件名: &quot; . $_FILES[&quot;file&quot;][&quot;name&quot;] . &quot;&lt;br&gt;&quot;;</div><div class="line">        echo &quot;文件类型: &quot; . $_FILES[&quot;file&quot;][&quot;type&quot;] . &quot;&lt;br&gt;&quot;;</div><div class="line">        echo &quot;文件大小: &quot; . ($_FILES[&quot;file&quot;][&quot;size&quot;] / 1024) . &quot; kB&lt;br&gt;&quot;;</div><div class="line">        echo &quot;文件临时存储的位置: &quot; . $_FILES[&quot;file&quot;][&quot;tmp_name&quot;] . &quot;&lt;br&gt;&quot;;</div><div class="line">        </div><div class="line">        // 判断当期目录下的 upload 目录是否存在该文件</div><div class="line">        // 如果没有 upload 目录，你需要创建它，upload 目录权限为 777</div><div class="line">        if (file_exists(&quot;upload/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;]))</div><div class="line">        &#123;</div><div class="line">            echo $_FILES[&quot;file&quot;][&quot;name&quot;] . &quot; 文件已经存在。 &quot;;</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            // 如果 upload 目录不存在该文件则将文件上传到 upload 目录下</div><div class="line">            move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], &quot;upload/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;]);</div><div class="line">            echo &quot;文件存储在: &quot; . &quot;upload/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">else</div><div class="line">&#123;</div><div class="line">    echo &quot;非法的文件格式&quot;;</div><div class="line">&#125;</div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>之前一直以为这是框架的内容，其实这是php自带的，框架可能只是对他的封装和安全性的校验。如果有时候实在上传出错，试试这个数组。</p>
<p>几个要注意的点：</p>
<ol>
<li>临时上传文件的地址可以通过phpinfo() 查看，但如果你真到那个文件夹下是找不到的，通过move_uploaded_file 函数移动到你需要的位置。因为我们itbasic之前的上传都写好了，导致我以为上传直接上传到指定的文件夹。</li>
<li>几个函数 is_dir  判断文件夹是否存在，file_exists,判断文件是否存在，<br>move_uploaded_file 移动文件。注意创建文件夹的时候给权限755.</li>
<li>移动到新的地址直接返回新的地址给前端就可以了。</li>
<li>注意一下我们平时比如itbasic上表单的提交都不是以form这种格式，都是直接通过按钮触发click事件，然后获取页面内容进行提交，这种方式是上传不了文件的，我们可以利用jq，<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var writeData = new FormData();</div><div class="line">writeData.append(&apos;object&apos;, objid);</div></pre></td></tr></table></figure>
</li>
</ol>
<p>然后往里面添加属性，通过append</p>
<ol>
<li>之前还上传过base64格式的image图片，其实这个要比前面的文件上传简单很多，这个与其说是上传文件，不如说是保存数据内容。</li>
</ol>
<p>一个image的base64格式码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">data:image/png;base64,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</div></pre></td></tr></table></figure></p>
<p>图片在使用的时候只用image src=”” 等于上面这串内容就可以了。像wangeditor里面，写的内容，两种保存图片的方式：1.base64， 直接把这个image src = base64格式保存在html中 2.把文件上传到服务器上，然后获取链接地址。</p>
<p>base64 php处理代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">if (preg_match(&apos;/^(data:\s*image\/(\w+);base64,)/&apos;, $src, $result))&#123;</div><div class="line">                $type = $result[2];</div><div class="line">                $body = str_replace($result[1], &apos;&apos;, $src);</div><div class="line">                $filename = $path.date(&apos;YmdHis&apos;, time()).&apos;.&apos;.$type;</div><div class="line">                if (file_put_contents($filename, base64_decode($body)))&#123;</div><div class="line"></div><div class="line">                &#125;else&#123;</div><div class="line">                    return [&apos;code&apos;=&gt;CODE_ERROR, &apos;msg&apos;=&gt;&apos;文件保存失败&apos;];</div><div class="line">                &#125;</div><div class="line">            &#125;</div></pre></td></tr></table></figure></p>
<p>大致说下一下，type 获取的是正则 （\w+）里面内容，代表图片的格式，<br>body 获取的正则的内容，注意看表达式最外面的（）括号，result[0]代表的是完全匹配内容。</p>
<p>php获取到图片base64加密后的内容，通过解密，file_put_contents 写入文件，返回文件地址。</p>
<p>上面是通过前端 js + 后端php，实现的文件上传，其实完全可以通过 php + php 实现，下面分别介绍通过这两种方式实现的大文件上传。</p>
<p>客户端php代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env php</div><div class="line">&lt;?php</div><div class="line"></div><div class="line">const DATRIX_URL = &quot;http://211.144.114.26:19980&quot;;</div><div class="line">//const DATRIX_URL = &quot;http://192.168.50.229&quot;;</div><div class="line">const DATRIX_UID = &quot;itbasic&quot;;</div><div class="line">const DATRIX_PUID = &quot;itbasic&quot;;</div><div class="line">//const DATRIX_DATA_DIR = &quot;9bbd816d16ff589aee0ffe0ce68323ba&quot;;</div><div class="line">//const DATRIX_DATA_OBJ = &quot;20180126/09/9bbd816d16ff589aee0ffe0ce68323ba&quot;;</div><div class="line">const DATRIX_DATA_DIR = &quot;4bb4db1235077fb2ba6ea2b9a0220693&quot;;</div><div class="line">const DATRIX_DATA_OBJ = &quot;20180125/16/4bb4db1235077fb2ba6ea2b9a0220693&quot;;</div><div class="line">const DATRIX_EXECUTE_ID = &quot;itbasic&quot;;</div><div class="line">const DATRIX_CREATE_URI = &quot;/api/sw/file/create&quot;;</div><div class="line">const DATRIX_WRITE_URI = &quot;/api/sw/file/write&quot;;</div><div class="line">const DATRIX_FINISH_URI = &quot;/api/sw/file/finish&quot;;</div><div class="line"></div><div class="line">$filename = substr(date(&apos;Ymd&apos;), 2).&apos;.sql.tar&apos;;</div><div class="line">$trueFileName = &apos;/var/dataitbasic/&apos;.$filename;</div><div class="line"></div><div class="line">function http_post_data($url, $params = array(), $string = 1)</div><div class="line">&#123;</div><div class="line">    if (is_array($params) &amp;&amp; $string)</div><div class="line">    &#123;</div><div class="line">        $params = http_build_query($params, null, &apos;&amp;&apos;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $ch = curl_init();</div><div class="line">    curl_setopt($ch, CURLOPT_POST, 1);</div><div class="line">    curl_setopt($ch, CURLOPT_URL, $url);</div><div class="line">    curl_setopt($ch, CURLOPT_ENCODING, &quot;&quot;);</div><div class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $params);</div><div class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);</div><div class="line">    $response = curl_exec($ch);</div><div class="line">    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</div><div class="line">    curl_close($ch);</div><div class="line"></div><div class="line">    return [$httpCode, json_decode($response,true)];</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">$param = [</div><div class="line">    &apos;filename&apos;=&gt;$filename,</div><div class="line">    &apos;filesize&apos;=&gt;filesize($trueFileName),</div><div class="line">    &apos;createuid&apos;=&gt;DATRIX_UID,</div><div class="line">    &apos;parentuid&apos;=&gt;DATRIX_PUID,</div><div class="line">    &apos;dirid&apos;=&gt;DATRIX_DATA_DIR,</div><div class="line">    &apos;parentobj&apos;=&gt;DATRIX_DATA_OBJ,</div><div class="line">    &apos;city&apos;=&gt;&apos;上海&apos;,</div><div class="line">    &apos;district&apos;=&gt;&apos;&apos;,</div><div class="line">    &apos;gps&apos;=&gt;&apos;121.48789949,31.24916171&apos;,</div><div class="line">    &apos;isperdir&apos;=&gt;&apos;true&apos;,</div><div class="line">    &apos;userid&apos;=&gt;DATRIX_EXECUTE_ID,</div><div class="line">    &apos;debug&apos;=&gt;true</div><div class="line">];</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">function uploadToDatrix($createParam, $trueFileName)</div><div class="line">&#123;</div><div class="line">    $block = 4*1024*1024;</div><div class="line"></div><div class="line">    $create = http_post_data(DATRIX_URL.DATRIX_CREATE_URI, $createParam, 1);</div><div class="line"></div><div class="line">    $objid = $create[1][&apos;result&apos;][&apos;objid&apos;];</div><div class="line"></div><div class="line">    if ($create[1][&apos;code&apos;] == 200) &#123;</div><div class="line"></div><div class="line">        if (filesize($trueFileName) &gt; $block) &#123;</div><div class="line">            </div><div class="line"></div><div class="line">            $dir = DIR.substr(date(&apos;Ymd&apos;), 2);</div><div class="line">            $handle = opendir($dir);</div><div class="line">            $fileArr = [];</div><div class="line">            while(($filename = readdir($handle)) !== false) &#123;</div><div class="line">                if (!is_dir($filename) &amp;&amp; $filename != &apos;.&apos; &amp;&amp; $filename != &apos;..&apos;) &#123;</div><div class="line">                    array_push($fileArr, $filename);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            closedir($handle);</div><div class="line">            $offset = 0;</div><div class="line">            foreach ($fileArr as $key=&gt;$value) &#123;</div><div class="line"></div><div class="line">                $writeParam = [</div><div class="line">                    &apos;object&apos;=&gt;$objid,</div><div class="line">                    &apos;bucket&apos;=&gt;DATRIX_EXECUTE_ID,</div><div class="line">                    &apos;length&apos;=&gt;filesize($dir.&apos;/&apos;.$value),</div><div class="line">                    &apos;debug&apos;=&gt;true,</div><div class="line">                    &apos;filedata&apos;=&gt;file_get_contents($dir.&apos;/&apos;.$value),</div><div class="line">                    &apos;offset&apos;=&gt;$offset</div><div class="line">                ];</div><div class="line">                $writeResult = http_post_data(DATRIX_URL.DATRIX_WRITE_URI, $writeParam, 0);</div><div class="line"></div><div class="line">                $offset += filesize($dir.&apos;/&apos;.$value);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            $finshData = [</div><div class="line">                &apos;objectid&apos;=&gt;$objid,</div><div class="line">                &apos;createuid&apos;=&gt;DATRIX_UID,</div><div class="line">                &apos;userid&apos;=&gt;DATRIX_EXECUTE_ID,</div><div class="line">                &apos;fileid&apos;=&gt;$create[1][&apos;result&apos;][&apos;fileid&apos;],</div><div class="line">                &apos;debug&apos;=&gt;true</div><div class="line">            ];</div><div class="line"></div><div class="line">            if ($writeResult[1][&apos;code&apos;] == 200) &#123;</div><div class="line">                $finish = http_post_data(DATRIX_URL.DATRIX_FINISH_URI, $finshData,1);</div><div class="line">            &#125;</div><div class="line">            if ($finish[1][&apos;code&apos;] != 200) &#123;</div><div class="line">                echo date(&apos;Ymd&apos;);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            //$file = fopen($trueFileName, &apos;rb&apos;);</div><div class="line">            //$content = fread($file, filesize($trueFileName));</div><div class="line"></div><div class="line">            //$content = fgets($file);</div><div class="line"></div><div class="line">            $content = file_get_contents($trueFileName);</div><div class="line"></div><div class="line">            //echo &quot;filesize:&quot;.filesize($trueFileName);</div><div class="line"></div><div class="line">            $writeParam = [</div><div class="line">                &apos;object&apos;=&gt;$objid,</div><div class="line">                &apos;bucket&apos;=&gt;DATRIX_EXECUTE_ID,</div><div class="line">                &apos;length&apos;=&gt;filesize($trueFileName),</div><div class="line">                &apos;debug&apos;=&gt;true,</div><div class="line">                &apos;filedata&apos;=&gt;$content,</div><div class="line">                &apos;offset&apos;=&gt;0</div><div class="line">            ];</div><div class="line"></div><div class="line">            $writeResult = http_post_data(DATRIX_URL.DATRIX_WRITE_URI, $writeParam, 0);</div><div class="line"></div><div class="line">            $finshData = [</div><div class="line">                &apos;objectid&apos;=&gt;$objid,</div><div class="line">                &apos;createuid&apos;=&gt;DATRIX_UID,</div><div class="line">                &apos;userid&apos;=&gt;DATRIX_EXECUTE_ID,</div><div class="line">                &apos;fileid&apos;=&gt;$create[1][&apos;result&apos;][&apos;fileid&apos;],</div><div class="line">                &apos;debug&apos;=&gt;true</div><div class="line">            ];</div><div class="line"></div><div class="line">            if ($writeResult[1][&apos;code&apos;] == 200) &#123;</div><div class="line">                $finish = http_post_data(DATRIX_URL.DATRIX_FINISH_URI, $finshData,1);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if ($finish[1][&apos;code&apos;] != 200) &#123;</div><div class="line">                echo date(&apos;Ymd&apos;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">uploadToDatrix($param, $trueFileName);</div></pre></td></tr></table></figure>
<p>http_post_data 是通过curl封装的post方法，需要注意的点是，传的post参数不要组装成string（post三种传递数据方式，string， 表单还有一种），其实我们平时可以通过观察控制台，发现我们itbasic的每次提交都是post方式，但是数据组装方式，有string，表单两种类型。<br>还有注意我之前一直file以为传文件名就可以了，··坑爹啊··这样传服务端怎么获取内容，用file_get_contents()获取文件内容。<br>（今天偶然碰见，file_get_contents()不能获取itbasic.app这种本地定义的域名哦）。</p>
<ul>
<li style="list-style: none"><input type="checkbox"> php读取指定文件大小</li>
<li style="list-style: none"><input type="checkbox"> 完整的php接受大文件上传</li>
</ul>
<p>上传大文件  js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line">var uploadToDatrix = function(fileObject, fileId, fileText, type, dirid, dirobj, pro, button) &#123; //参数是上传文件对象</div><div class="line">    if (button) &#123;</div><div class="line">        $(&apos;#&apos; + button).attr(&apos;disabled&apos;, &apos;disabled&apos;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    for (var i = 0; i&lt;fileObject.files.length; i++) &#123;</div><div class="line">        var file = fileObject.files[i]; //具体的文件</div><div class="line">        var filename = file.name;</div><div class="line">        var fileSize = file.size; console.log(file);</div><div class="line"></div><div class="line">        var data = &#123;</div><div class="line">            filename: filename,</div><div class="line">            filesize: fileSize,</div><div class="line">            createuid: DATRIX_UID,</div><div class="line">            parentuid: DATRIX_PUID,</div><div class="line">            dirid: dirid,</div><div class="line">            parentobj: dirobj,</div><div class="line">            city: &apos;上海市&apos;,</div><div class="line">            gps: &apos;121.48789949,31.24916171&apos;,</div><div class="line">            isperdir: true,</div><div class="line">            userid: DATRIX_EXECUTE_ID,</div><div class="line">            debug: &apos;true&apos;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        $.ajax(&#123;</div><div class="line">            url: DATRIX_URL+DATRIX_CREATE_URI,</div><div class="line">            type: &quot;POST&quot;,</div><div class="line">            dataType: &quot;json&quot;,</div><div class="line">            data: data,</div><div class="line">            success: function (data) &#123;</div><div class="line">                var back = data.result;</div><div class="line">                console.log(back);</div><div class="line">                /* var writeData = &#123;</div><div class="line">                 object: back.objid,</div><div class="line">                 bucket: &quot;itbasic&quot;,</div><div class="line">                 length: fileSize,</div><div class="line">                 offset: 0,</div><div class="line">                 debug: true</div><div class="line">                 &#125;*/</div><div class="line">                fileWrite (fileSize, back.objid, fileSize, file, 0, back, fileId, fileText, type, button);</div><div class="line"></div><div class="line">            &#125;,</div><div class="line">            error : function(error) &#123;</div><div class="line">                showAlert(&apos;上传失败&apos;, &apos;danger&apos;);</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">var fileWrite = function(uploadSize, objid, trueSize, file, start, back, fileId, fileText, type, button) &#123;</div><div class="line">    var writeData = new FormData();</div><div class="line"></div><div class="line">    if(uploadSize &lt;= 2 * 1024 * 1024) &#123;</div><div class="line">        var fileSize = uploadSize;</div><div class="line">    &#125; else &#123;</div><div class="line">        var fileSize = 2 * 1024 * 1024;</div><div class="line">    &#125;</div><div class="line">    var end = start * 1 + fileSize * 1;</div><div class="line">    var func = (file.mozSlice ? &apos;mozSlice&apos; : (file.webkitSlice ? &apos;webkitSlice&apos; : &apos;slice&apos;));</div><div class="line">    var uploadFile = file[func](start, end);</div><div class="line"></div><div class="line">    writeData.append(&apos;object&apos;, objid); //var writeData = new FormData();</div><div class="line">    writeData.append(&apos;bucket&apos;, &apos;itbasic&apos;);  //上传文件用户id</div><div class="line">    writeData.append(&apos;length&apos;, fileSize); //filesize,上传文件内容</div><div class="line">    writeData.append(&apos;offset&apos;,start); //文件开始点</div><div class="line">    writeData.append(&apos;debug&apos;, true);</div><div class="line">    writeData.append(&apos;file&apos;, uploadFile); //文件内容</div><div class="line"></div><div class="line">    console.log(start, fileSize, uploadSize);</div><div class="line"></div><div class="line">    $.ajax(&#123;</div><div class="line">        url: DATRIX_URL+DATRIX_WRITE_URI,</div><div class="line">        type: &quot;POST&quot;,</div><div class="line">        dataType: &quot;json&quot;,</div><div class="line">        data: writeData,</div><div class="line">        processData: false,</div><div class="line">        contentType: false,</div><div class="line">        async : false,</div><div class="line">        success : function(data) &#123;</div><div class="line">            //console.log(data);</div><div class="line">            uploadSize = uploadSize - fileSize;</div><div class="line">            console.log(uploadSize);</div><div class="line">            if (uploadSize*1 &gt; 0) &#123;</div><div class="line">                fileWrite(uploadSize, objid, trueSize, file, end, back, fileId, fileText, type, button);</div><div class="line">                return ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            var finishData = &#123;</div><div class="line">                objectid:back.objid,</div><div class="line">                createuid:DATRIX_UID,</div><div class="line">                userid:DATRIX_EXECUTE_ID,</div><div class="line">                fileid:back.fileid,</div><div class="line">                debug:true</div><div class="line">            &#125;</div><div class="line">            $.ajax(&#123;</div><div class="line">                url: DATRIX_URL+DATRIX_FINISH_URI,</div><div class="line">                type: &quot;POST&quot;,</div><div class="line">                dataType: &quot;json&quot;,</div><div class="line">                data: finishData,</div><div class="line">                async : false,</div><div class="line">                success : function() &#123;</div><div class="line">                    $(&apos;#&apos;+button).removeAttr(&apos;disabled&apos;);</div><div class="line">                    if (pro == 1) &#123;</div><div class="line">                        var f = &#123;&apos;fname&apos;:back.filename,&apos;fid&apos;:back.fileid, &apos;objectid&apos;:back.objid&#125;;</div><div class="line">                        uploadContractFile.push(f); console.log(uploadContractFile);</div><div class="line"></div><div class="line">                    &#125; else &#123;</div><div class="line"></div><div class="line">                        if (fileId) &#123;</div><div class="line">                            var file_id = $(&apos;#&apos; + fileId).val();</div><div class="line">                            var upload_text = $(&apos;#&apos; + fileText).val() || &apos;&apos;;</div><div class="line">                            if (!file_id) &#123;</div><div class="line">                                file_id = back.fileid + &apos;,&apos; + back.filename;</div><div class="line">                                $(&apos;#&apos; + fileId).val(file_id);</div><div class="line">                            &#125; else &#123;</div><div class="line">                                file_id = file_id + &apos;,&apos; + back.fileid + &apos;,&apos; + back.filename;</div><div class="line">                                $(&apos;#&apos; + fileId).val(file_id);</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            if (!upload_text) &#123;</div><div class="line">                                upload_text = back.filename;</div><div class="line">                                $(&apos;#&apos; + fileText).val(upload_text);</div><div class="line">                            &#125; else &#123;</div><div class="line">                                upload_text = upload_text + &apos; , &apos; + back.filename;</div><div class="line">                                $(&apos;#&apos; + fileText).val(upload_text);</div><div class="line">                            &#125;</div><div class="line">                        &#125; else &#123;</div><div class="line">                            var upload_text = $(fileText).find(&apos;.upload_text&apos;).val() || &apos;&apos;;</div><div class="line">                            var html = &apos;&lt;a href=&quot;javascript:;&quot; class=&quot;primary-link preview&quot; data-filename=&quot;&apos;+back.filename+&apos;&quot; data-fileid=&quot;&apos;+back.fileid+&apos;&quot; data-objid=&quot;&apos;+back.objid+&apos;&quot;&gt; &apos;+ back.filename +&apos; &lt;/a&gt;&apos;;</div><div class="line">                            $(fileText).find(&apos;.file_preview&apos;).append(html);</div><div class="line">                            if (!upload_text) &#123;</div><div class="line">                                upload_text = back.filename;</div><div class="line">                                $(fileText).find(&apos;.upload_text&apos;).val(upload_text);</div><div class="line">                            &#125; else &#123;</div><div class="line">                                upload_text = upload_text + &apos; , &apos; + back.filename;</div><div class="line">                                $(fileText).find(&apos;.upload_text&apos;).val(upload_text);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        Model.addupload(&#123;</div><div class="line">                            fileid: back.fileid,</div><div class="line">                            filename: back.filename,</div><div class="line">                            type: type,</div><div class="line">                            objectid: back.objid</div><div class="line">                        &#125;, function (res) &#123;</div><div class="line">                            if (res.code === CODE_SUCCESS) &#123;</div><div class="line"></div><div class="line">                            &#125; else if (res.code === CODE_ERROR) &#123;</div><div class="line">                                showAlert(res.msg, &apos;danger&apos;);</div><div class="line">                            &#125;</div><div class="line">                        &#125;)</div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                error: function() &#123;</div><div class="line">                    showAlert(&apos;上传失败&apos;, &apos;danger&apos;);</div><div class="line">                &#125;</div><div class="line">            &#125;)</div><div class="line">        &#125;,</div><div class="line">        error : function() &#123;</div><div class="line">            showAlert(&apos;上传失败&apos;, &apos;danger&apos;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>没维护了，以后接着看吧。</p>
<p>php 文件处理，主要包括文件的分割和合并</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">function file_split($file,$block_size=  2 * 1024 * 1024)&#123;</div><div class="line">        $block_info=[];</div><div class="line">        $size=filesize($file);</div><div class="line">        $i=0;</div><div class="line">        while($size&gt;0)&#123;</div><div class="line">            $block_info[]= [</div><div class="line">                &apos;size&apos;=&gt;($size&gt;=$block_size?$block_size:$size),</div><div class="line">                &apos;file&apos;=&gt;$file.&apos;.&apos;.$i++</div><div class="line">            ];</div><div class="line">            $size-=$block_size;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        $fp = fopen($file,&quot;rb&quot;);</div><div class="line">        foreach ($block_info as $bi) &#123;</div><div class="line">            $handle = fopen($bi[&apos;file&apos;],&quot;wb&quot;);</div><div class="line">            fwrite($handle,fread($fp,$bi[&apos;size&apos;]));</div><div class="line">            fclose($handle);</div><div class="line">            unset($handle);</div><div class="line">        &#125;</div><div class="line">        fclose ($fp);</div><div class="line">        unset($fp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    function file_combine($file,$save_file=&apos;&apos;)&#123;</div><div class="line">        $filename=basename($file);</div><div class="line">        $filepath=dirname($file).&apos;/&apos;;</div><div class="line">        $block_info=array();</div><div class="line">        for($i=0;;$i++)&#123;</div><div class="line">            if(file_exists($file.&apos;.&apos;.$i) &amp;&amp; filesize($file.&apos;.&apos;.$i)&gt;0)&#123;</div><div class="line">                $block_info[]=$file.&apos;.&apos;.$i;</div><div class="line">            &#125;else&#123;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if($save_file)&#123;</div><div class="line">            $fp   = fopen($save_file,&quot;wb&quot;);</div><div class="line">        &#125;else&#123;</div><div class="line">            $fp   = fopen($file,&quot;wb&quot;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        foreach ($block_info as $block_file) &#123;</div><div class="line">            $handle = fopen($block_file,&quot;rb&quot;);</div><div class="line">            fwrite($fp,fread($handle,filesize($block_file)));</div><div class="line">            fclose($handle);</div><div class="line">            unset($handle);</div><div class="line">        &#125;</div><div class="line">        fclose ($fp);</div><div class="line">        unset($fp);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>php上传大文件有种就是先用php进行文件分割成小文件，然后小文件上传，然后上传到服务器上进行大文件合并。但有个问题就是php读取文件的fopen就8192字节，也就是8192B，一般上传文件都是4mb的上传，所以用的linux split分割文件后，放入文件夹里面，然后遍历文件夹，读取内容，写入操作的时候传入同一个objectid，往同一个文件里面写入</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wp.png" alt="chenye2017 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/zp1.png" alt="chenye2017 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

  <div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
  </div>

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/PHP/" rel="tag"><i class="fa fa-tag"></i> PHP</a>
          
            <a href="/tags/文件上传/" rel="tag"><i class="fa fa-tag"></i> 文件上传</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/24/ThinkPHP5-学习笔记/" rel="next" title="ThinkPHP5 学习笔记">
                <i class="fa fa-chevron-left"></i> ThinkPHP5 学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/29/PHP文件操作/" rel="prev" title="PHP文件操作">
                PHP文件操作 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/my.png"
                alt="chenye2017" />
            
              <p class="site-author-name" itemprop="name">chenye2017</p>
              <p class="site-description motion-element" itemprop="description">想用善良改变世界</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/chenye2017" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:1967196626@qq.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/3215254425" target="_blank" title="Weibo">
                    
                      <i class="fa fa-fw fa-globe"></i>Weibo</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-crosshairs"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.baidu.com/" title="百度" target="_blank">百度</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.google.com/" title="谷歌" target="_blank">谷歌</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenye2017</span>

  
</div>


<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span> |
</span>
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>





  <span class="post-meta-divider">|</span>





  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>


<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count"> | 博客全站共51.1k字</span>
</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  

  

  


  
   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>



</body>
</html>
